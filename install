#!/bin/bash

set -e  # выход при первой ошибке

# Цвета для вывода
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

error() {
    echo -e "${RED}err: $1${NC}" >&2
    exit 1
}

info() {
    echo -e "${GREEN}=> $1${NC}"
}

# Проверка обязательных утилит
for cmd in go cp sudo; do
    if ! command -v "$cmd" &> /dev/null; then
        error "'$cmd' не установлен"
    fi
done

# Определяем init-систему
init_system=""

# Проверяем системы в порядке приоритета
if command -v rc-service &> /dev/null && [ -d "/etc/init.d" ]; then
    init_system="openrc"
elif command -v dinitctl &> /dev/null && [ -d "/etc/dinit.d" ]; then
    init_system="dinit"
elif [ -d "/etc/sv" ] && [ -d "/var/service" ]; then
    init_system="runit"
else
    error "Не найдена поддерживаемая init-система (OpenRC, dinit или runit)"
fi

info "Обнаружена init-система: $init_system"

# Пути к исходникам
SRC_OPENRC="system/openrc/systemctl.go"
SRC_RUNIT="system/runit/systemctl.go"
SRC_DINIT="system/dinit/systemctl.go"
BINARY_NAME="systemctl"

# Проверяем наличие нужного файла
case "$init_system" in
    "openrc")
        if [ ! -f "$SRC_OPENRC" ]; then
            error "Файл $SRC_OPENRC не найден"
        fi
        SRC_FILE="$SRC_OPENRC"
        ;;
    "runit")
        if [ ! -f "$SRC_RUNIT" ]; then
            error "Файл $SRC_RUNIT не найден"
        fi
        SRC_FILE="$SRC_RUNIT"
        ;;
    "dinit")
        if [ ! -f "$SRC_DINIT" ]; then
            error "Файл $SRC_DINIT не найден"
        fi
        SRC_FILE="$SRC_DINIT"
        ;;
    *)
        error "Неподдерживаемая init-система"
        ;;
esac

# Сборка
info "Сборка для $init_system..."
CGO_ENABLED=0 GOOS=linux go build -a -ldflags '-s -w -extldflags "-static"' -o "$BINARY_NAME" "$SRC_FILE"

# Установка
info "Установка в /usr/local/bin/..."
sudo install -m 755 "$BINARY_NAME" /usr/local/bin/"$BINARY_NAME"

# Уборка
rm -f "$BINARY_NAME"

info "Готово! Утилита systemctl установлена для $init_system."
